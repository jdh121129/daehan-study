<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DAEHAN STUDY - FINAL V33 (NICKNAME EDIT)</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2232/2232688.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f0f7f6; 
            margin: 0; padding: 0; 
            overflow: hidden; 
            height: 100vh; height: 100dvh;
            -webkit-user-select: none; user-select: none;
            touch-action: manipulation;
        }
        input, textarea { -webkit-user-select: text; user-select: text; }

        #bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        #app-container { width: 100%; max-width: 1280px; margin: 0 auto; height: 100%; position: relative; z-index: 10; display: flex; flex-direction: column; }
        
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 16px 24px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: flex; items-center; gap: 12px; transform: translateY(-100%); opacity: 0; transition: all 0.4s; border: 1px solid rgba(255,255,255,0.5); pointer-events: auto; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-success .toast-icon { color: #10b981; } .toast-error .toast-icon { color: #ef4444; }
        .toast-msg { font-weight: 800; color: #1e293b; font-size: 14px; }

        #cheat-overlay {
            display: none; position: fixed; inset: 0; background: rgba(225, 29, 72, 0.98); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center; text-align: center; color: white;
            backdrop-filter: blur(10px);
        }
        #cheat-overlay.active { display: flex; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #decibel-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 10px; background: rgba(255,255,255,0.5); padding: 10px 20px; border-radius: 20px; width: 100%; }
        .decibel-bar-bg { flex: 1; height: 10px; background: #e2e8f0; border-radius: 99px; overflow: hidden; }
        .decibel-bar-fill { height: 100%; background: linear-gradient(90deg, #39c5bb, #f43f5e); width: 0%; transition: width 0.1s linear; }

        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        .hidden { display: none !important; }
        
        .level-progress-bg { background: #e2e8f0; border-radius: 99px; overflow: hidden; height: 8px; width: 100%; }
        .level-progress-fill { background: linear-gradient(90deg, #39c5bb, #63e6be); height: 100%; transition: width 0.5s ease-out; }

        .particle { position: absolute; pointer-events: none; border-radius: 50%; opacity: 0.6; }
        @keyframes fall { 0% { transform: translateY(-10vh); opacity: 0.8; } 100% { transform: translateY(110vh); opacity: 0; } }

        @media (min-width: 768px) { 
            #main-content { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; padding: 40px !important; } 
            .tab-content { grid-column: 1 / -1; } 
            #tab-study .glass-card { max-width: 800px; margin: 0 auto; } 
        }

        .nav-btn.active { color: #39c5bb; transform: scale(1.1); font-weight: 900; background-color: rgba(57, 197, 187, 0.1); } .nav-btn { color: #94a3b8; transition: all 0.2s; }
        
        .rank-item:nth-child(1) { border: 2px solid #fcd34d; background: #fffbeb; }
        .rank-item:nth-child(1) .rank-crown { display: block; color: #fbbf24; }
        .rank-crown { display: none; }
        
        .paused-blink { animation: blinker 1.5s linear infinite; color: #f59e0b; }
        @keyframes blinker { 50% { opacity: 0.3; } }

        button:disabled { background-color: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #39c5bb; }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body oncontextmenu="return false" ondragstart="return false">
    
    <div id="bg-layer"></div>
    <div id="toast-container"></div>

    <div id="nickname-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[30px] shadow-2xl w-80 text-center relative overflow-hidden border-4 border-teal-100">
            <h2 class="text-2xl font-black text-slate-800 mb-2">ğŸ‘‹ ë°˜ê°€ì›Œìš”!</h2>
            <p class="text-slate-500 text-sm mb-6 font-bold">ë­í‚¹ì— í‘œì‹œë  ë©‹ì§„<br>ë‹‰ë„¤ì„ì„ ì§€ì–´ì£¼ì„¸ìš”.</p>
            <input type="text" id="new-nickname-input" class="w-full bg-slate-100 text-slate-800 border-2 border-slate-200 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-teal-500 transition-colors text-center font-black placeholder-slate-400" placeholder="í•œê¸€, ì˜ì–´, ìˆ«ì ê°€ëŠ¥">
            <button onclick="saveInitialNickname()" class="w-full py-3 rounded-xl bg-teal-500 text-white font-black shadow-lg hover:bg-teal-600 transition-all">ì‹œì‘í•˜ê¸° ğŸš€</button>
        </div>
    </div>

    <div id="cheat-overlay">
        <i class="fas fa-exclamation-triangle fa-5x mb-6 animate-pulse text-yellow-300"></i>
        <h1 class="text-6xl font-black mb-4">ë”´ì§“ ê°ì§€! ğŸš¨</h1>
        <p class="text-2xl font-bold mb-8">í™”ë©´ì„ ë²—ì–´ë‚˜ì„œ íƒ€ì´ë¨¸ê°€ ë©ˆì·„ìŠµë‹ˆë‹¤.</p>
        <button onclick="resumeFromCheat()" class="bg-white text-rose-600 px-8 py-4 rounded-2xl font-black text-xl hover:scale-105 transition-transform shadow-xl">
            ë‹¤ì‹œ ì§‘ì¤‘í•˜ê² ìŠµë‹ˆë‹¤ ğŸ˜­
        </button>
    </div>

    <div id="app-container">
        <header class="h-20 flex-none flex items-center justify-between px-6 bg-white/70 backdrop-blur-md shadow-sm border-b border-white/50 z-50">
            <div class="absolute top-5 left-5 md:left-6 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-teal-400 animate-pulse"></div>
                <span id="top-username" class="text-slate-500 font-black text-sm tracking-tight">ë¡œë”©ì¤‘...</span>
            </div>

            <div id="top-date" class="font-black text-slate-400 text-xs tracking-wide hidden md:block opacity-0"></div> <div class="flex-1 flex flex-col items-center justify-center max-w-md mx-auto w-full">
                <div class="flex items-end gap-2 mb-1">
                    <span id="header-lvl" class="text-xs font-black bg-teal-500 text-white px-1.5 py-0.5 rounded shadow-sm">LV.1</span>
                    <div id="top-time" class="text-[#39c5bb] text-2xl font-black tracking-widest leading-none">00:00</div>
                </div>
                <div class="w-full max-w-[200px] flex flex-col gap-1">
                    <div class="level-progress-bg"><div id="header-exp-bar" class="level-progress-fill" style="width: 0%"></div></div>
                </div>
            </div>
            
            <button onclick="logout()" class="relative z-[100] text-slate-500 hover:text-rose-600 p-3 bg-slate-100 rounded-full transition-all active:scale-95" title="ë¡œê·¸ì•„ì›ƒ">
                <i class="fas fa-power-off fa-lg"></i>
            </button>
        </header>

        <div id="lock-screen" class="absolute inset-0 bg-[#39c5bb] flex items-center justify-center z-[110] px-4 transition-transform duration-500">
            <div class="bg-white/95 backdrop-blur-xl p-10 rounded-[40px] shadow-2xl w-full max-w-sm text-center">
                <h1 class="text-4xl font-black text-slate-800 mb-2">DAEHAN STUDY</h1>
                <p class="text-slate-400 font-bold mb-8 text-sm">ì¤‘í•™ìƒì„ ìœ„í•œ ë ˆë²¨ì—… ê³µë¶€ ì•±</p>
                
                <div id="login-view">
                    <input type="text" id="login-id" class="w-full p-4 bg-slate-100 rounded-2xl mb-3 text-center font-bold outline-none" placeholder="ì•„ì´ë”” (ë˜ëŠ” ì´ë©”ì¼)">
                    <input type="password" id="login-pw" onkeydown="if(event.key==='Enter') checkLogin()" class="w-full p-4 bg-slate-100 rounded-2xl mb-6 text-center font-bold outline-none" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    <button onclick="checkLogin()" class="w-full bg-[#39c5bb] text-white py-4 rounded-2xl font-black shadow-lg hover:brightness-110 transition-all">ì…ì¥í•˜ê¸° ğŸš€</button>
                    <button onclick="toggleAuthMode()" class="mt-6 text-xs font-bold text-slate-400 underline">ê³„ì • ë§Œë“¤ê¸°</button>
                    
                    <p class="text-slate-400 text-xs mt-4 break-keep">
                        â€» ë³„ë„ì˜ ê°€ì… ì ˆì°¨ ì—†ì´ <span class="text-[#39c5bb] font-bold">êµ¬ê¸€ ê³„ì •</span>ìœ¼ë¡œ ë°”ë¡œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    </p>
                </div>

                <div id="register-view" class="hidden">
                    <input type="text" id="reg-id" class="w-full p-4 bg-slate-100 rounded-2xl mb-3 text-center font-bold outline-none" placeholder="ì•„ì´ë””">
                    <input type="password" id="reg-pw" class="w-full p-4 bg-slate-100 rounded-2xl mb-2 text-center font-bold outline-none" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    <button onclick="registerUser()" class="w-full bg-indigo-500 text-white py-4 rounded-2xl font-black shadow-lg mt-4">ê°€ì… ì™„ë£Œ âœ¨</button>
                    <button onclick="toggleAuthMode()" class="mt-4 text-xs font-bold text-slate-400">ë’¤ë¡œ ê°€ê¸°</button>
                    
                    <p class="text-slate-400 text-xs mt-4 break-keep">
                        â€» <span class="text-indigo-500 font-bold">êµ¬ê¸€ ê³„ì •</span>ì„ ì‚¬ìš©í•˜ì‹œë©´ ë³„ë„ì˜ ê°€ì…ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>

        <div id="main-app" class="hidden flex-1 overflow-hidden relative flex flex-col">
            <main id="main-content" class="flex-1 p-6 overflow-y-auto scroll-smooth pb-4">
                
                <div id="tab-home" class="tab-content w-full max-w-4xl mx-auto space-y-8">
                    <div class="glass-card p-8 rounded-[30px] text-center shadow-lg relative">
                        <div class="bg-gradient-to-r from-teal-50 to-blue-50 border border-teal-100 rounded-2xl p-5 mb-6 text-left relative overflow-hidden flex justify-between items-center">
                            <div>
                                <div class="text-xs font-black text-teal-600 uppercase mb-1">Current Level</div>
                                <div id="home-lvl-display" class="text-4xl font-black text-slate-700">LV.1</div>
                                <div id="home-remain-time" class="text-xs text-slate-400 font-bold mt-1">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ?ë¶„</div>
                            </div>
                            <div class="text-right"><div class="text-xs font-bold text-slate-400 mb-1">ëª©í‘œì¼(D-Day)</div><div id="home-d-day" class="text-2xl font-black text-rose-500">D-??</div></div>
                        </div>
                        <div class="bg-slate-800 text-white p-4 rounded-2xl mb-6 relative overflow-hidden shadow-inner min-h-[100px] flex items-center justify-center">
                            <i class="fas fa-quote-left text-slate-600 absolute top-2 left-2 text-3xl opacity-30"></i><p id="quote-text" class="text-lg font-black relative z-10 break-keep leading-relaxed">"ì˜¤ëŠ˜ ê±·ì§€ ì•Šìœ¼ë©´ ë‚´ì¼ì€ ë›°ì–´ì•¼ í•œë‹¤."</p><i class="fas fa-quote-right text-slate-600 absolute bottom-2 right-2 text-3xl opacity-30"></i>
                        </div>
                        <button onclick="toggleNoteModal()" class="absolute top-6 right-6 bg-yellow-400 text-yellow-900 px-4 py-2 rounded-xl font-black shadow-md hover:bg-yellow-300 transition-all text-sm z-10 flex items-center"><i class="fas fa-sticky-note mr-2"></i> ë…¸íŠ¸</button>
                        <div class="aspect-video bg-black rounded-[20px] overflow-hidden shadow-2xl relative mt-4"><div id="yt-player" class="absolute inset-0 w-full h-full"></div></div>
                    </div>
                </div>

                <div id="tab-study" class="tab-content hidden w-full">
                    <div class="glass-card p-6 md:p-8 rounded-[40px] shadow-2xl text-center border-2 border-white/50 relative">
                        <div class="mb-8">
                            <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">ê³¼ëª© ì„ íƒ (7ê³¼ëª©)</label>
                            <div class="relative w-full max-w-[280px] mx-auto group">
                                <select id="subject-select" onchange="changeSubject()" class="appearance-none w-full bg-white border-4 border-teal-100 text-slate-700 py-4 pl-6 pr-12 rounded-3xl text-xl font-black outline-none focus:border-teal-400 cursor-pointer shadow-sm">
                                    <option value="êµ­ì–´">ğŸ“š êµ­ì–´</option><option value="ìˆ˜í•™">ğŸ“ ìˆ˜í•™</option><option value="ì˜ì–´">ğŸ”¤ ì˜ì–´</option><option value="ê³¼í•™">ğŸ”¬ ê³¼í•™</option><option value="ì‚¬íšŒ">ğŸŒ ì‚¬íšŒ</option><option value="í•œêµ­ì‚¬">ğŸ¯ í•œêµ­ì‚¬</option><option value="ì„¸ê³„ì‚¬">ğŸ“œ ì„¸ê³„ì‚¬</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-4 flex items-center text-teal-500"><i class="fas fa-chevron-down"></i></div>
                            </div>
                        </div>
                        <div class="mb-8 relative py-4">
                            <div class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-2">í‘¼ ë¬¸ì œ ìˆ˜</div>
                            <div id="total-count-display" class="text-[#39c5bb] text-[100px] md:text-[120px] font-black tracking-tighter leading-none transition-all drop-shadow-sm">0</div>
                            <button onclick="addCount(1)" class="w-full mt-4 py-4 rounded-2xl font-black text-xl bg-white text-teal-600 border-2 border-teal-100 shadow-md hover:bg-teal-50 transition-all flex items-center justify-center gap-2 transform active:scale-95"><i class="fas fa-plus-circle"></i> ë¬¸ì œ í’€ì—ˆì–´!</button>
                        </div>
                        
                        <div class="flex flex-col items-center justify-center mb-8">
                            <div id="timer" class="text-5xl md:text-6xl font-black text-slate-700 font-mono tracking-tight mb-2">00:00</div>
                            <div id="pace-display" class="text-sm font-bold text-teal-600 bg-teal-50 px-3 py-1 rounded-lg">âš¡ í˜„ì¬ í˜ì´ìŠ¤: 2ë¶„ë‹¹ 0.0ë¬¸ì œ</div>
                        </div>

                        <div id="time-warning" class="text-xs text-rose-500 font-bold mb-4 hidden animate-pulse">ìµœì†Œ 10ì´ˆ ì´ìƒ ê³µë¶€í•´ì•¼ ì €ì¥ë©ë‹ˆë‹¤!</div>
                        
                        <div id="decibel-wrapper" class="hidden flex-col items-start gap-2">
                            <div class="flex items-center gap-2 w-full">
                                <i class="fas fa-microphone text-slate-400"></i>
                                <div class="decibel-bar-bg"><div id="decibel-bar" class="decibel-bar-fill"></div></div>
                                <span id="decibel-text" class="text-xs font-bold text-slate-400 w-10">0dB</span>
                            </div>
                            <div class="w-full flex items-center gap-2 mt-1 px-1">
                                <span class="text-[10px] text-slate-400 whitespace-nowrap">ë¯¼ê°ë„:</span>
                                <input type="range" id="mic-sens-slider-study" min="1" max="10" step="0.5" value="1.5" class="w-full cursor-pointer h-1.5 bg-slate-200 rounded-lg appearance-none accent-teal-500">
                            </div>
                        </div>

                        <div class="flex gap-4 mt-8">
                            <button id="toggle-btn" onclick="toggleStudy()" class="flex-1 py-6 rounded-3xl font-black text-xl md:text-2xl bg-teal-500 text-white shadow-xl hover:bg-teal-600 transition-all">ê³µë¶€ ì‹œì‘ â–¶</button>
                            <button id="end-btn" onclick="endStudyAndSave()" class="flex-1 py-6 rounded-3xl font-black text-xl md:text-2xl bg-rose-500 text-white shadow-xl transition-all opacity-40" disabled>ì¢…ë£Œ â– </button>
                        </div>
                    </div>
                </div>

                <div id="tab-rank" class="tab-content hidden w-full max-w-3xl mx-auto">
                    <div class="glass-card p-6 md:p-8 rounded-[30px] flex flex-col h-[75vh]">
                        <h3 class="text-2xl font-black text-slate-800 uppercase mb-4">ğŸ† ë­í‚¹</h3>
                        <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-6">
                            <button onclick="switchRankMode('monthly')" class="flex-1 py-2 rounded-xl font-bold text-sm bg-teal-500 text-white shadow-sm" id="rank-mode-monthly">ì›”ê°„</button>
                            <button onclick="switchRankMode('level')" class="flex-1 py-2 rounded-xl font-bold text-sm text-slate-400 hover:bg-slate-200" id="rank-mode-level">ì „ì²´</button>
                        </div>
                        <div id="rank-list" class="space-y-3 pb-4 overflow-y-auto pr-2 custom-scroll flex-1"></div>
                    </div>
                </div>

                <div id="tab-history" class="tab-content hidden w-full max-w-3xl mx-auto">
                    <div class="glass-card p-8 rounded-[30px]">
                        <h3 class="text-2xl font-black text-slate-800 uppercase mb-8">ğŸ“š ê³µë¶€ ê¸°ë¡</h3>
                        <div id="history-list" class="space-y-4 pb-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>

                <div id="tab-settings" class="tab-content hidden w-full max-w-3xl mx-auto">
                    <div class="glass-card p-10 rounded-[40px] shadow-lg space-y-8">
                        <h3 class="text-3xl font-black text-slate-800 uppercase border-b-2 border-slate-100 pb-6">ì„¤ì • ë° ê°€ì´ë“œ âš™ï¸</h3>
                        
                        <div class="bg-teal-50 border border-teal-200 p-6 rounded-3xl flex justify-between items-center">
                            <div>
                                <h4 class="text-xl font-black text-teal-800 mb-1">ğŸ‘‘ ë‚´ ë ˆë²¨ í˜„í™©</h4>
                                <div id="settings-remain-text" class="text-sm text-teal-600 font-bold">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ?ë¶„</div>
                            </div>
                            <div id="settings-lvl-display" class="text-4xl font-black text-teal-500">LV.1</div>
                        </div>

                        <div class="bg-white border border-slate-200 p-6 rounded-3xl flex items-center justify-between gap-4">
                             <div class="flex items-center gap-4">
                                 <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-2xl">ğŸ‘¤</div>
                                 <div id="user-email-display">
                                     <div class="text-xl font-black text-slate-700">ë‹‰ë„¤ì„ ë¡œë”©ì¤‘...</div>
                                     <div class="text-xs text-slate-400">ì´ë©”ì¼ ì •ë³´</div>
                                 </div>
                             </div>
                             <button onclick="changeNickname()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold rounded-xl transition-colors">
                                 <i class="fas fa-pen mr-1"></i>ë‹‰ë„¤ì„ ë³€ê²½
                             </button>
                        </div>

                        <div class="bg-indigo-50 border border-indigo-200 p-6 rounded-3xl">
                            <h4 class="text-xl font-black text-indigo-800 mb-2">ğŸ“… ì‹œí—˜ ëª©í‘œì¼ (D-Day)</h4>
                            <div class="flex gap-2"><input type="date" id="d-day-input" class="flex-1 p-3 rounded-xl border border-indigo-100 text-slate-700 font-bold outline-none"><button onclick="saveDDay()" class="bg-indigo-500 text-white px-6 rounded-xl font-bold hover:bg-indigo-600">ì €ì¥</button></div>
                        </div>
                        <div>
                            <h4 class="text-lg font-black text-slate-700 mb-2">ğŸµ ì‚¬ìš´ë“œ & ë§ˆì´í¬</h4>
                            <div class="space-y-4">
                                <div class="bg-white/50 p-4 rounded-2xl border border-slate-200 flex justify-between items-center">
                                    <div><div class="font-bold text-slate-600">ë§ˆì´í¬ ì‚¬ìš©</div><div class="text-xs text-slate-400">ë„ë©´ ìˆœìˆ˜ íƒ€ì´ë¨¸ë¡œë§Œ ì‘ë™</div></div>
                                    <label class="switch"><input type="checkbox" id="mic-toggle-switch" checked onchange="toggleMicUse()"><span class="slider"></span></label>
                                </div>
                                <div class="bg-white/50 p-4 rounded-2xl border border-slate-200">
                                    <div class="flex justify-between items-center mb-2"><span class="font-bold text-slate-600">ë§ˆì´í¬ ë¯¼ê°ë„</span><span id="mic-sens-value" class="font-black text-rose-500">x1.5</span></div>
                                    <input type="range" id="mic-sens-slider" min="1" max="10" step="0.5" value="1.5" class="w-full cursor-pointer h-2 bg-slate-200 rounded-lg appearance-none accent-rose-500">
                                </div>
                                <div class="bg-white/50 p-4 rounded-2xl border border-slate-200">
                                    <div class="flex justify-between items-center mb-2"><span class="font-bold text-slate-600">Lo-fi ë°°ê²½ìŒì•…</span><span id="bgm-vol-value" class="font-black text-teal-600">30%</span></div>
                                    <input type="range" id="bgm-volume-slider" min="0" max="100" value="30" class="w-full cursor-pointer h-2 bg-slate-200 rounded-lg appearance-none accent-teal-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <div id="note-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 backdrop-blur-sm bg-black/30 z-[120]">
                <div class="bg-white w-full max-w-md h-[80vh] rounded-[30px] shadow-2xl flex flex-col overflow-hidden relative border-4 border-teal-100">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-teal-50">
                        <h3 class="font-black text-xl text-slate-800">ğŸ“ ê³µë¶€ ë…¸íŠ¸</h3>
                        <button onclick="toggleNoteModal()" class="text-slate-400 hover:text-slate-600 text-xl"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="note-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50"></div>
                    <div class="p-4 bg-white border-t border-slate-100">
                        <textarea id="note-input" onkeydown="if(event.ctrlKey && event.key === 'Enter') saveNote()" class="w-full p-4 bg-slate-100 rounded-2xl text-sm font-medium outline-none resize-none h-24 focus:ring-2 focus:ring-teal-400" placeholder="ë‚´ìš© ì…ë ¥... (Ctrl + Enter ì €ì¥)"></textarea>
                        <div class="mt-2">
                            <p class="text-xs text-rose-600 font-black mb-2 animate-pulse">ğŸš¨ ê²½ê³ : ë„ë°° ì‹œ 1ì‹œê°„ ë’¤ ëª¨ë“  ê¸°ë¡ ì‚­ì œ</p>
                            <button id="note-save-btn" onclick="saveNote()" class="w-full bg-teal-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-teal-600 shadow-md transition-all">ì €ì¥í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="h-24 flex-none bg-white/80 backdrop-blur-xl border-t border-slate-200 z-50 flex justify-center items-center pb-2 px-6 gap-2 md:gap-6 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                <button onclick="showTab('home')" class="nav-btn flex flex-col items-center gap-1.5 p-3 px-4 md:px-8 rounded-2xl active" id="nav-home"><i class="fas fa-home text-2xl"></i><span class="text-xs font-bold">í™ˆ</span></button>
                <button onclick="showTab('study')" class="nav-btn flex flex-col items-center gap-1.5 p-3 px-4 md:px-8 rounded-2xl" id="nav-study"><i class="fas fa-stopwatch text-2xl"></i><span class="text-xs font-bold">ì—´ê³µ</span></button>
                <button onclick="showTab('rank')" class="nav-btn flex flex-col items-center gap-1.5 p-3 px-4 md:px-8 rounded-2xl" id="nav-rank"><i class="fas fa-trophy text-2xl"></i><span class="text-xs font-bold">ë­í‚¹</span></button>
                <button onclick="showTab('history')" class="nav-btn flex flex-col items-center gap-1.5 p-3 px-4 md:px-8 rounded-2xl" id="nav-history"><i class="fas fa-list-ul text-2xl"></i><span class="text-xs font-bold">ê¸°ë¡</span></button>
                <button onclick="showTab('settings')" class="nav-btn flex flex-col items-center gap-1.5 p-3 px-4 md:px-8 rounded-2xl" id="nav-settings"><i class="fas fa-cog text-2xl"></i><span class="text-xs font-bold">ì„¤ì •</span></button>
            </aside>
        </div>
    </div>

    <script>
        // [ë³´ì•ˆ] F12 ë° ê´€ë¦¬ì ë„êµ¬ ë‹¨ì¶•í‚¤, ìš°í´ë¦­ ë°©ì§€ ì½”ë“œ
        document.addEventListener('keydown', function(event) {
            if (event.key === 'F12') { event.preventDefault(); return false; }
            if (event.ctrlKey && event.shiftKey && (event.key === 'I' || event.key === 'i')) { event.preventDefault(); return false; }
            if (event.ctrlKey && event.shiftKey && (event.key === 'J' || event.key === 'j')) { event.preventDefault(); return false; }
            if (event.ctrlKey && (event.key === 'U' || event.key === 'u')) { event.preventDefault(); return false; }
        });
        document.addEventListener('contextmenu', function(event) { event.preventDefault(); return false; });

        const studyQuotes = ["í”¼í•  ìˆ˜ ì—†ìœ¼ë©´ ì¦ê²¨ë¼.", "ì˜¤ëŠ˜ ê±·ì§€ ì•Šìœ¼ë©´ ë‚´ì¼ì€ ë›°ì–´ì•¼ í•œë‹¤.", "ê³µë¶€ëŠ” ë§ˆë¼í†¤ì´ë‹¤. í¬ê¸°í•˜ì§€ ë§ˆë¼.", "ë‚˜íƒœí•¨ì€ ë‹¬ì½¤í•˜ì§€ë§Œ ê²°ê³¼ëŠ” ë¹„ì°¸í•˜ë‹¤.", "ë„ˆì˜ ë¯¸ë˜ëŠ” ì§€ê¸ˆ ë„¤ê°€ ë¬´ì—‡ì„ í•˜ëŠëƒì— ë‹¬ë ¤ìˆë‹¤.", "ì²œì¬ëŠ” 1%ì˜ ì˜ê°ê³¼ 99%ì˜ ë•€ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ë‹¤.", "ê¿ˆì„ ê¾¸ê¸°ì— ëŠ¦ì€ ë‚˜ì´ë€ ì—†ë‹¤.", "ì§€ê¸ˆ ì ì„ ìë©´ ê¿ˆì„ ê¾¸ì§€ë§Œ, ì§€ê¸ˆ ê³µë¶€í•˜ë©´ ê¿ˆì„ ì´ë£¬ë‹¤.", "ê³ í†µ ì—†ì´ëŠ” ì–»ëŠ” ê²ƒë„ ì—†ë‹¤ (No Pain, No Gain).", "ê°€ì¥ í° ì ì€ ì–´ì œì˜ ë‚˜ë‹¤.", "ë…¸ë ¥ì€ ë°°ì‹ í•˜ì§€ ì•ŠëŠ”ë‹¤.", "ì‹œì‘ì´ ë°˜ì´ë‹¤.", "ëŠ¦ì—ˆë‹¤ê³  ìƒê°í•  ë•Œê°€ ê°€ì¥ ë¹ ë¥¼ ë•Œë‹¤.", "ì„±ê³µì€ ë§¤ì¼ ë°˜ë³µë˜ëŠ” ì‘ì€ ë…¸ë ¥ë“¤ì˜ í•©ì´ë‹¤.", "ì˜¤ëŠ˜ ë³´ë‚¸ í•˜ë£¨ëŠ” ë‚´ì¼ ë‹¤ì‹œ ëŒì•„ì˜¤ì§€ ì•ŠëŠ”ë‹¤.", "ê³µë¶€í•  ë•Œì˜ ê³ í†µì€ ì ê¹ì´ì§€ë§Œ, ëª» ë°°ìš´ ê³ í†µì€ í‰ìƒì´ë‹¤.", "ë„¤ê°€ í—›ë˜ì´ ë³´ë‚¸ ì˜¤ëŠ˜ì€ ì–´ì œ ì£½ì€ ì´ê°€ ê·¸í† ë¡ ê°ˆë§í•˜ë˜ ë‚´ì¼ì´ë‹¤.", "ë¶ˆê°€ëŠ¥ì´ë€ ë…¸ë ¥í•˜ì§€ ì•ŠëŠ” ìì˜ ë³€ëª…ì´ë‹¤.", "ì±…ìƒì€ ìƒê°ë³´ë‹¤ ë„“ê³ , ë„¤ ê¿ˆì€ ìƒê°ë³´ë‹¤ í¬ë‹¤.", "ì‹¤íŒ¨ëŠ” ì„±ê³µì˜ ì–´ë¨¸ë‹ˆì´ë‹¤.", "ë‚¨ë³´ë‹¤ ë” ì¼ì° ë¶€ì§€ëŸ°íˆ ë…¸ë ¥í•´ì•¼ ì„±ê³µì˜ ë§›ì„ ë³¸ë‹¤.", "ì§€ê¸ˆ í˜ë¦° ì¹¨ì€ ë‚´ì¼ í˜ë¦´ ëˆˆë¬¼ì´ ëœë‹¤.", "10ë¶„ ë’¤ì— ì´ ì±…ì„ ë®ëŠ” ë„¤ ëª¨ìŠµì´ ìë‘ìŠ¤ëŸ½ê¸¸ ë°”ë€ë‹¤.", "ì§‘ì¤‘ë ¥ì€ ìµœê³ ì˜ ë¬´ê¸°ë‹¤.", "í•œê³„ëŠ” ë„¤ê°€ ì •í•˜ëŠ” ê²ƒì´ë‹¤.", "ì„±ì ì€ íˆ¬ìí•œ ì‹œê°„ê³¼ ë¹„ë¡€í•œë‹¤.", "ì˜¤ëŠ˜ì˜ ë•€ë°©ìš¸ì´ ë‚´ì¼ì˜ ì›ƒìŒì´ ëœë‹¤.", "ìµœì„ ì„ ë‹¤í–ˆë‹¤ëŠ” ë§ì´ ë¶€ë„ëŸ½ì§€ ì•Šê²Œ í•˜ë¼.", "ë„¤ê°€ ê¿ˆì„ ì´ë£¨ë©´ ë„Œ ë‹¤ì‹œ ëˆ„êµ°ê°€ì˜ ê¿ˆì´ ëœë‹¤.", "ê³µë¶€í•˜ë¼, ì„¸ìƒì´ ë°”ë€ë‹¤."];

        function setRandomQuote() {
            const index = Math.floor(Math.random() * studyQuotes.length);
            const quoteEl = document.getElementById('quote-text');
            if(quoteEl) quoteEl.innerText = `"${studyQuotes[index]}"`;
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDubCYnThrj_eYoWzBtw23SSLTvxJhMp_I",
            authDomain: "daehan-study.firebaseapp.com",
            projectId: "daehan-study",
            storageBucket: "daehan-study.firebasestorage.app",
            messagingSenderId: "1096091007680",
            appId: "1:1096091007680:web:86686e317da5a105d28b25"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let currentUserNickname = "í•™ìƒ"; 

        let isStudying = false;
        let isPaused = false; 
        let timerInterval = null;
        let seconds = 0;
        let totalProblems = 0;
        let currentSubject = "êµ­ì–´"; 
        let myTotalStudyTime = 0;
        
        let player; 
        let wakeLock = null; 

        let isPermissionCheck = false;
        let gracePeriod = false; 

        let currentRankMode = 'monthly'; 
        let rankUnsubscribe = null;
        let lastRankLoadTime = 0;
        let audioContext, analyser, microphone, decibelInterval;
        
        let micSensitivity = 1.5; 
        let useMic = true; 
        let savedDDay = null;

        let lastNoteTime = 0;
        let lastNoteContent = "";
        let lastSoundCountTime = 0; 

        const SUBJECT_ICONS = {"êµ­ì–´": "ğŸ“š", "ìˆ˜í•™": "ğŸ“", "ì˜ì–´": "ğŸ”¤", "ê³¼í•™": "ğŸ”¬", "ì‚¬íšŒ": "ğŸŒ", "í•œêµ­ì‚¬": "ğŸ¯", "ì„¸ê³„ì‚¬": "ğŸ“œ"};

        // [ë”´ì§“ ê°ì§€ ë¡œì§]
        document.addEventListener("visibilitychange", () => { if (isPermissionCheck || gracePeriod) return; if (document.hidden && isStudying && !isPaused) forcePauseStudy(); });
        window.addEventListener("blur", () => { if (isPermissionCheck || gracePeriod) return; if (isStudying && !isPaused) forcePauseStudy(); });

        function forcePauseStudy() {
            if(isPaused) return;
            toggleStudy(); 
            document.getElementById('cheat-overlay').classList.add('active'); 
            document.title = "ğŸš¨ ë”´ì§“ ê°ì§€ë¨!!";
        }

        function resumeFromCheat() {
            document.getElementById('cheat-overlay').classList.remove('active');
            document.title = "DAEHAN STUDY";
            showToast("ë‹¤ì‹œ ì§‘ì¤‘í•´ë³´ì! ğŸ”¥", "success");
            if(isPaused) toggleStudy(); 
        }

        window.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('subject-select');
            if(select) currentSubject = select.value;
            startParticles();
            setRandomQuote();
            loadLocalSettings();
            updateDDayDisplay();
        });

        function loadLocalSettings() {
            const savedMic = localStorage.getItem('daehan_use_mic');
            if(savedMic !== null) { useMic = (savedMic === 'true'); document.getElementById('mic-toggle-switch').checked = useMic; }
            savedDDay = localStorage.getItem('daehan_dday');
            if(savedDDay) document.getElementById('d-day-input').value = savedDDay;
        }

        function toggleMicUse() {
            useMic = document.getElementById('mic-toggle-switch').checked;
            localStorage.setItem('daehan_use_mic', useMic);
            if(useMic) showToast("ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.", "success"); else showToast("ë§ˆì´í¬ê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤. (ìˆ˜ë™ ëª¨ë“œ)", "success");
        }

        function saveDDay() {
            const val = document.getElementById('d-day-input').value;
            if(!val) return showToast("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!", "error");
            savedDDay = val; localStorage.setItem('daehan_dday', val); updateDDayDisplay(); showToast("D-Day ì €ì¥ ì™„ë£Œ! ğŸ“…", "success");
        }

        function updateDDayDisplay() {
            if(!savedDDay) { document.getElementById('home-d-day').innerText = "ì„¤ì •í•„ìš”"; return; }
            const target = new Date(savedDDay).getTime();
            const now = new Date().getTime();
            const diff = target - now;
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            let text = ""; if(days > 0) text = `D-${days}`; else if(days === 0) text = "D-Day"; else text = `D+${Math.abs(days)}`;
            document.getElementById('home-d-day').innerText = text;
        }

        function calculateLevel(totalSeconds) {
            let level = 1;
            let spent = totalSeconds;
            while (true) {
                let requiredForNext = level * 600; 
                if (spent >= requiredForNext) {
                    spent -= requiredForNext; 
                    level++; 
                } else {
                    const percent = (spent / requiredForNext) * 100;
                    return { level: level, percent: Math.min(100, percent), remainingSec: requiredForNext - spent };
                }
            }
        }

        function updateLevelUI() {
            if(!currentUser) return;
            
            const info = calculateLevel(myTotalStudyTime + seconds);
            const remainingMins = Math.ceil(info.remainingSec / 60);

            const headerLvl = document.getElementById('header-lvl');
            const headerBar = document.getElementById('header-exp-bar');
            if(headerLvl) headerLvl.innerText = `LV.${info.level}`;
            if(headerBar) headerBar.style.width = `${info.percent}%`;
            
            const homeLvl = document.getElementById('home-lvl-display');
            const homeRemain = document.getElementById('home-remain-time');
            if(homeLvl) homeLvl.innerText = `LV.${info.level}`;
            if(homeRemain) homeRemain.innerText = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${remainingMins}ë¶„`;
            
            const setLvl = document.getElementById('settings-lvl-display');
            const setRemain = document.getElementById('settings-remain-text');
            if(setLvl) setLvl.innerText = `LV.${info.level}`;
            if(setRemain) setRemain.innerText = `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${remainingMins}ë¶„`;
        }

        async function startDecibelMeter() {
            if (!useMic) { document.getElementById('decibel-wrapper').classList.add('hidden'); return; }
            isPermissionCheck = true; 
            try {
                document.getElementById('decibel-wrapper').classList.remove('hidden');
                document.getElementById('decibel-wrapper').classList.add('flex'); 
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                microphone.connect(analyser);
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                decibelInterval = setInterval(() => {
                    analyser.getByteFrequencyData(dataArray);
                    let sum = 0; for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                    let average = sum / dataArray.length;
                    let width = Math.min(100, average * micSensitivity); 
                    document.getElementById('decibel-bar').style.width = width + "%";
                    document.getElementById('decibel-text').innerText = Math.floor(average) + "";
                    if (average > 10 && (average * micSensitivity > 50)) {
                        const now = Date.now();
                        if (now - lastSoundCountTime > 2000) { 
                            addCount(1);
                            lastSoundCountTime = now;
                            document.getElementById('decibel-bar').style.backgroundColor = '#f43f5e';
                            setTimeout(() => { document.getElementById('decibel-bar').style.backgroundColor = ''; }, 200);
                        }
                    }
                }, 100);
            } catch (err) {
                console.log("ë§ˆì´í¬ ê¶Œí•œ ê±°ë¶€ë¨"); showToast("ë§ˆì´í¬ ê¶Œí•œì´ ì—†ì–´ ìˆ˜ë™ ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤.", "error");
                document.getElementById('decibel-wrapper').classList.add('hidden');
            } finally { setTimeout(() => { isPermissionCheck = false; }, 1000); }
        }

        function stopDecibelMeter() {
            if (decibelInterval) { clearInterval(decibelInterval); decibelInterval = null; }
            if (audioContext && audioContext.state !== 'closed') audioContext.close().catch(e => console.error(e));
            audioContext = null; 
            document.getElementById('decibel-wrapper').classList.add('hidden');
            document.getElementById('decibel-wrapper').classList.remove('flex');
        }

        function showToast(msg, type = "success") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icon = type === "success" ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
            const typeClass = type === "success" ? 'toast-success' : 'toast-error';
            toast.className = `toast ${typeClass}`;
            toast.innerHTML = `<div class="toast-icon">${icon}</div><div class="toast-msg">${msg}</div>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 3000);
        }

        // Auth ë° ë‹‰ë„¤ì„ ë¡œì§
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                db.collection("users").doc(user.uid).onSnapshot(doc => {
                    const data = doc.data();
                    if(data) { 
                        myTotalStudyTime = data.totalStudyTime || 0; 
                        
                        if (data.nickname) {
                            currentUserNickname = data.nickname;
                            updateUIWithNickname();
                        } else {
                            document.getElementById('nickname-modal').classList.remove('hidden');
                        }
                        updateLevelUI(); 
                    } else {
                        document.getElementById('nickname-modal').classList.remove('hidden');
                    }
                });

                loadHistory(); loadRankings(); 
                if(player && typeof player.playVideo === 'function') player.playVideo();
                showToast(`í™˜ì˜í•©ë‹ˆë‹¤!`, "success");
            }
        });

        function saveInitialNickname() {
            const input = document.getElementById('new-nickname-input');
            const newName = input.value.trim();
            if (newName.length < 1) { showToast("ë‹‰ë„¤ì„ì„ í•œ ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”!", "error"); return; }

            db.collection('users').doc(currentUser.uid).set({
                email: currentUser.email,
                nickname: newName,
                totalStudyTime: myTotalStudyTime 
            }, { merge: true }).then(() => {
                currentUserNickname = newName;
                document.getElementById('nickname-modal').classList.add('hidden');
                updateUIWithNickname();
                showToast(`ë°˜ê°€ì›Œìš”, ${newName}ë‹˜!`, "success");
            }).catch((error) => {
                showToast("ì €ì¥ ì˜¤ë¥˜: " + error.message, "error");
            });
        }

        // [ì¶”ê°€] ë‹‰ë„¤ì„ ë³€ê²½ ê¸°ëŠ¥ (ì„¤ì •ì°½ì—ì„œ í˜¸ì¶œ)
        async function changeNickname() {
            const newName = prompt("ìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:", currentUserNickname);
            if (!newName || newName.trim() === "") return;
            if (newName === currentUserNickname) return;

            try {
                await db.collection('users').doc(currentUser.uid).update({
                    nickname: newName.trim()
                });
                currentUserNickname = newName.trim();
                updateUIWithNickname();
                showToast("ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰", "success");
            } catch(e) {
                showToast("ë‹‰ë„¤ì„ ë³€ê²½ ì‹¤íŒ¨: " + e.message, "error");
            }
        }

        function updateUIWithNickname() {
            const topNameEl = document.getElementById('top-username'); 
            if(topNameEl) topNameEl.innerText = currentUserNickname;

            const settingsEmail = document.getElementById('user-email-display');
            if(settingsEmail) {
                settingsEmail.innerHTML = `
                    <div class="text-xl font-black text-slate-700">${currentUserNickname}</div>
                    <div class="text-xs text-slate-400">${currentUser.email}</div>
                `;
            }
        }

        function toggleAuthMode() {
            document.getElementById('login-view').classList.toggle('hidden');
            document.getElementById('register-view').classList.toggle('hidden');
        }

        function registerUser() {
            const id = document.getElementById('reg-id').value.trim();
            const pw = document.getElementById('reg-pw').value.trim();
            if (!id || pw.length < 6) return showToast("ì•„ì´ë”” & ë¹„ë²ˆ 6ìë¦¬ ì´ìƒ!", "error");
            const email = id.includes('@') ? id : id + "@study.com";
            auth.createUserWithEmailAndPassword(email, pw).then((cred) => {
                db.collection("users").doc(cred.user.uid).set({ id: id, totalStudyTime: 0, monthlyStudyTime: 0, lastStudyMonth: "" }); 
                showToast("ê°€ì… ì„±ê³µ! ğŸ‰", "success");
            }).catch(e => showToast("ê°€ì… ì‹¤íŒ¨: " + e.message, "error"));
        }

        function checkLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pw = document.getElementById('login-pw').value.trim();
            if(!id || !pw) return showToast("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "error");
            const email = id.includes('@') ? id : id + "@study.com";
            auth.signInWithEmailAndPassword(email, pw).catch(() => showToast("ë¡œê·¸ì¸ ì‹¤íŒ¨ âŒ", "error"));
        }

        async function logout() { 
            try {
                if(isStudying) resetStudy();
                if(player && typeof player.stopVideo === 'function') {
                    player.stopVideo();
                }
            } catch(e) { console.log("Cleanup error ignored"); }

            auth.signOut().then(() => {
                localStorage.clear(); 
                location.reload(); 
            }).catch(err => {
                location.reload(); 
            });
        }

        function changeSubject() { 
            currentSubject = document.getElementById('subject-select').value;
            showToast(`${currentSubject}(ìœ¼)ë¡œ ë³€ê²½ë¨`, "success");
        }
        
        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }

        function checkEndButtonState() {
            const endBtn = document.getElementById('end-btn');
            const warning = document.getElementById('time-warning');
            if (seconds >= 10) { 
                endBtn.disabled = false; 
                endBtn.classList.remove('opacity-40', 'bg-rose-500'); 
                endBtn.classList.add('bg-red-600'); 
                warning.classList.add('hidden'); 
            } else { 
                endBtn.disabled = true; 
            }
        }

        function toggleStudy() {
            const btn = document.getElementById('toggle-btn');
            const endBtn = document.getElementById('end-btn');

            if (!isStudying) {
                isStudying = true; isPaused = false;
                gracePeriod = true; setTimeout(() => { gracePeriod = false; }, 3000); 
                runTimer(); startDecibelMeter(); requestWakeLock();
                if(player && player.getPlayerState() !== 1) player.playVideo();
                btn.innerText = "ì¼ì‹œì •ì§€ â¸";
                btn.className = "flex-1 py-6 rounded-3xl font-black text-xl md:text-2xl bg-yellow-400 text-yellow-900 shadow-xl hover:bg-yellow-500 transition-all transform hover:-translate-y-1";
                endBtn.classList.remove('opacity-40'); 
                document.getElementById('time-warning').classList.remove('hidden');
                checkEndButtonState(); 
            } else if (!isPaused) {
                isPaused = true;
                clearInterval(timerInterval); stopDecibelMeter(); 
                btn.innerText = "ë‹¤ì‹œ ì‹œì‘ â–¶";
                btn.className = "flex-1 py-6 rounded-3xl font-black text-xl md:text-2xl bg-teal-500 text-white shadow-xl hover:bg-teal-600 transition-all";
                document.getElementById('timer').classList.add('paused-blink');
                document.title = "â¸ ì¼ì‹œì •ì§€ë¨";
                checkEndButtonState(); 
            } else {
                isPaused = false;
                gracePeriod = true; setTimeout(() => { gracePeriod = false; }, 3000);
                runTimer(); startDecibelMeter(); 
                btn.innerText = "ì¼ì‹œì •ì§€ â¸";
                btn.className = "flex-1 py-6 rounded-3xl font-black text-xl md:text-2xl bg-yellow-400 text-yellow-900 shadow-xl hover:bg-yellow-500 transition-all";
                document.getElementById('timer').classList.remove('paused-blink');
                checkEndButtonState(); 
            }
        }

        function runTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
                document.title = `${m}:${s} - ì—´ê³µì¤‘ ğŸ”¥`;
                updateLevelUI();
                
                if (seconds > 0) {
                    const pace = (totalProblems / seconds) * 120;
                    document.getElementById('pace-display').innerText = `âš¡ í˜„ì¬ í˜ì´ìŠ¤: 2ë¶„ë‹¹ ${pace.toFixed(1)}ë¬¸ì œ`;
                }

                checkEndButtonState(); 
            }, 1000);
        }

        async function endStudyAndSave() {
            if (!isStudying) return;
            if (seconds < 10) { showToast("10ì´ˆ ì´ìƒ ê³µë¶€í•´ì•¼ ì €ì¥ë©ë‹ˆë‹¤!", "error"); return; }
            
            clearInterval(timerInterval);
            try { stopDecibelMeter(); } catch(e) {}
            
            const endBtn = document.getElementById('end-btn');
            endBtn.innerText = "ì €ì¥ ì¤‘..."; endBtn.disabled = true;

            try {
                if (currentUser) {
                    const now = new Date();
                    const currentMonthKey = `${now.getFullYear()}-${now.getMonth() + 1}`; 
                    const userRef = db.collection("users").doc(currentUser.uid);
                    
                    const pace = (seconds > 0) ? (totalProblems / seconds) * 120 : 0;

                    const userDoc = await userRef.get();
                    const userData = userDoc.exists ? userDoc.data() : { totalStudyTime: 0, monthlyStudyTime: 0, lastStudyMonth: "" };
                    
                    let newMonthly = (userData.monthlyStudyTime || 0);
                    if (userData.lastStudyMonth !== currentMonthKey) newMonthly = seconds; else newMonthly += seconds;
                    
                    await userRef.collection("history").add({ 
                        date: new Date(), 
                        subject: currentSubject, 
                        seconds: seconds, 
                        problems: totalProblems,
                        pace: pace.toFixed(1)
                    });

                    await userRef.set({ 
                        totalStudyTime: firebase.firestore.FieldValue.increment(seconds), 
                        monthlyStudyTime: newMonthly, 
                        lastStudyMonth: currentMonthKey 
                    }, { merge: true });

                    showToast("ì €ì¥ ì™„ë£Œ! ğŸ‘", "success");
                }
            } catch (e) { 
                console.error(e); showToast("ì €ì¥ ì˜¤ë¥˜ (ì¬ì‹œë„í•˜ì„¸ìš”)", "error"); 
            } finally { 
                resetStudy(); 
            }
        }

        function resetStudy() {
            isStudying = false; isPaused = false; seconds = 0; totalProblems = 0; 
            clearInterval(timerInterval); timerInterval = null;
            document.getElementById('timer').innerText = "00:00";
            document.getElementById('timer').classList.remove('paused-blink');
            document.getElementById('total-count-display').innerText = "0";
            document.getElementById('pace-display').innerText = "âš¡ í˜„ì¬ í˜ì´ìŠ¤: 2ë¶„ë‹¹ 0.0ë¬¸ì œ";
            document.title = "DAEHAN STUDY";
            const btn = document.getElementById('toggle-btn');
            btn.innerText = "ê³µë¶€ ì‹œì‘ â–¶";
            btn.className = "flex-1 py-6 rounded-3xl font-black text-xl md:text-2xl bg-teal-500 text-white shadow-xl hover:bg-teal-600 transition-all";
            const endBtn = document.getElementById('end-btn');
            
            endBtn.innerText = "ì¢…ë£Œ â– "; 
            endBtn.disabled = true; 
            endBtn.classList.remove('bg-red-600');
            endBtn.classList.add('bg-rose-500', 'opacity-40');
            
            document.getElementById('decibel-wrapper').classList.add('hidden');
            document.getElementById('decibel-wrapper').classList.remove('flex');
            document.getElementById('time-warning').classList.add('hidden');
            updateLevelUI();
        }

        function addCount(num) {
            if(!isStudying || isPaused) return;
            totalProblems += num;
            document.getElementById('total-count-display').innerText = totalProblems;
        }

        function toggleNoteModal() {
            const modal = document.getElementById('note-modal');
            if(modal.classList.contains('hidden')) { modal.classList.remove('hidden'); loadNotes(); } else modal.classList.add('hidden');
        }

        function loadNotes() {
            if(!currentUser) return;
            db.collection("users").doc(currentUser.uid).collection("notes").orderBy("date", "desc").limit(30).onSnapshot(snapshot => {
                const list = document.getElementById('note-list'); list.innerHTML = "";
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const item = document.createElement('div');
                    item.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative group";
                    item.innerHTML = `<p class="text-xs text-slate-400 mb-1">${d.date.toDate().toLocaleString()}</p><p class="text-slate-700 text-sm whitespace-pre-wrap">${d.text}</p><button onclick="if(confirm('ì‚­ì œ?')) db.collection('users').doc('${currentUser.uid}').collection('notes').doc('${doc.id}').delete()" class="absolute top-3 right-3 text-slate-300 hover:text-rose-500 p-2"><i class="fas fa-trash"></i></button>`;
                    list.appendChild(item);
                });
            });
        }

        async function saveNote() {
            if(!currentUser) return;
            const now = Date.now();
            const btn = document.getElementById('note-save-btn');
            const input = document.getElementById('note-input'); 
            const text = input.value.trim();

            if(!text) return showToast("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!", "error");
            if(now - lastNoteTime < 3000) { showToast("ë„ˆë¬´ ë¹¨ë¼ìš”! 3ì´ˆë§Œ ì‰¬ì„¸ìš” â³", "error"); return; }
            if(text === lastNoteContent) { showToast("ì´ë¯¸ ë“±ë¡í•œ ë‚´ìš©ì…ë‹ˆë‹¤. (ë„ë°° ë°©ì§€)", "error"); return; }
            
            const isSpamPattern = /(.)\1{5,}/.test(text); 
            if(isSpamPattern) {
                showToast("ğŸš¨ ë„ë°° ê°ì§€! 1ì‹œê°„ ë‚´ë¡œ ì •ë¦¬ ì•ˆ í•˜ë©´ ë…¸íŠ¸ í­íŒŒë¨!", "error");
                setTimeout(() => { deleteAllNotes(); }, 3600000); 
            }

            lastNoteTime = now; lastNoteContent = text;
            btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘...";

            await db.collection("users").doc(currentUser.uid).collection("notes").add({ text: text, date: new Date() });
            showToast("ë…¸íŠ¸ ì €ì¥ë¨ ğŸ“", "success"); input.value = ""; 
            setTimeout(() => { btn.disabled = false; btn.innerText = "ì €ì¥í•˜ê¸°"; }, 3000);
        }

        async function deleteAllNotes() {
            if(!currentUser) return;
            const userRef = db.collection("users").doc(currentUser.uid);
            const snapshot = await userRef.collection("notes").get();
            const batch = db.batch();
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            showToast("ğŸ’£ ë„ë°° íŒ¨ë„í‹°ë¡œ ëª¨ë“  ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "error");
        }

        function loadHistory() {
            if(!currentUser) return;
            db.collection("users").doc(currentUser.uid).collection("history").orderBy("date", "desc").limit(30).onSnapshot(snapshot => {
                const list = document.getElementById('history-list'); list.innerHTML = "";
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const m = Math.floor((d.seconds || 0) / 60);
                    const pace = d.pace ? `(í˜ì´ìŠ¤: ${d.pace})` : ""; 
                    const icon = SUBJECT_ICONS[d.subject] || "ğŸ“";
                    const item = document.createElement('div');
                    item.className = "bg-slate-50 p-5 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center";
                    item.innerHTML = `<div class="flex flex-col"><span class="font-bold text-slate-700 mb-1">[${icon} ${d.subject}] <span class="text-teal-600">${d.problems}ë¬¸ì œ</span> <span class="text-xs text-rose-400">${pace}</span></span><span class="text-xs text-slate-400 font-medium">${m}ë¶„</span></div><button onclick="if(confirm('ì‚­ì œ?')) db.collection('users').doc('${currentUser.uid}').collection('history').doc('${doc.id}').delete()" class="text-slate-300 hover:text-rose-500 p-2"><i class="fas fa-trash"></i></button>`;
                    list.appendChild(item);
                });
            });
        }

        function switchRankMode(mode) {
            currentRankMode = mode;
            document.getElementById('rank-mode-monthly').className = mode === 'monthly' ? 'flex-1 py-2 rounded-xl font-bold text-sm bg-teal-500 text-white shadow-sm' : 'flex-1 py-2 rounded-xl font-bold text-sm text-slate-400 hover:bg-slate-200';
            document.getElementById('rank-mode-level').className = mode === 'level' ? 'flex-1 py-2 rounded-xl font-bold text-sm bg-teal-500 text-white shadow-sm' : 'flex-1 py-2 rounded-xl font-bold text-sm text-slate-400 hover:bg-slate-200';
            loadRankings();
        }

        function loadRankings() {
            const now = Date.now();
            if (now - lastRankLoadTime < 10000) return; 
            lastRankLoadTime = now;
            const list = document.getElementById('rank-list');
            list.innerHTML = "<div class='text-center py-10 text-slate-400 font-bold'><i class='fas fa-spinner fa-spin'></i> ë­í‚¹ ê°±ì‹  ì¤‘...</div>";

            if (rankUnsubscribe) rankUnsubscribe();
            let query = db.collection("users");
            const dateObj = new Date();
            const currentKey = `${dateObj.getFullYear()}-${dateObj.getMonth() + 1}`;

            if (currentRankMode === 'monthly') query = query.where("lastStudyMonth", "==", currentKey).orderBy("monthlyStudyTime", "desc");
            else query = query.orderBy("totalStudyTime", "desc");

            rankUnsubscribe = query.limit(30).onSnapshot(snapshot => {
                list.innerHTML = "";
                if(snapshot.empty) { list.innerHTML = `<div class='text-center text-slate-400 mt-10'>ë°ì´í„° ì—†ìŒ</div>`; return; }
                let rank = 1;
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const timeToShow = currentRankMode === 'monthly' ? (d.monthlyStudyTime || 0) : (d.totalStudyTime || 0);
                    const hours = Math.floor(timeToShow / 3600);
                    const mins = Math.floor((timeToShow % 3600) / 60);
                    const isMe = currentUser && currentUser.uid === doc.id;
                    
                    const displayName = d.nickname || (d.id || "ì•Œ ìˆ˜ ì—†ìŒ").substring(0, 10);
                    
                    const item = document.createElement('div');
                    item.className = `rank-item p-4 rounded-xl shadow-sm border flex items-center justify-between ${isMe ? "bg-teal-50 border-teal-200" : "bg-white border-slate-100"} relative`;
                    item.innerHTML = `<div class="absolute -top-3 -right-2 text-2xl rank-crown"><i class="fas fa-crown"></i></div><div class="flex items-center gap-4"><span class="font-black text-lg text-slate-500">${rank}</span><div class="flex flex-col"><span class="font-bold text-slate-700 text-sm ${isMe ? 'text-teal-700' : ''}">${displayName}</span></div></div><div class="font-black text-[#39c5bb] text-lg tracking-tight">${hours}h ${mins}m</div>`;
                    list.appendChild(item);
                    rank++;
                });
            }, error => {
                if(error.code === 'failed-precondition') list.innerHTML = `<div class='text-center text-rose-500 font-bold mt-4 text-xs p-4 border border-rose-200 bg-rose-50 rounded-xl'>âš ï¸ [ê´€ë¦¬ì] ê°œë°œì ì½˜ì†”ì—ì„œ<br>ìƒ‰ì¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.</div>`;
            });
        }

        function showTab(tab) { 
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); 
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nav-' + tab).classList.add('active');
            if(tab === 'rank') loadRankings();
            if(tab === 'home') setRandomQuote(); 
        }

        function startParticles() {
            setInterval(() => {
                const p = document.createElement('div'); p.classList.add('particle');
                p.style.left = Math.random() * 100 + "%"; p.style.backgroundColor = '#39c5bb';
                p.style.animation = `fall ${Math.random()*3+4}s linear`;
                p.style.width = Math.random()*8+4+"px"; p.style.height = p.style.width;
                document.getElementById('bg-layer').appendChild(p);
                setTimeout(() => p.remove(), 7000);
            }, 500);
        }

        function onYouTubeIframeAPIReady() { 
            player = new YT.Player('yt-player', { 
                height: '100%', width: '100%', videoId: 'jfKfPfyJRdk', 
                playerVars: { 'autoplay': 0, 'controls': 1, 'playsinline': 1, 'origin': window.location.origin },
                events: { 'onReady': function(e) { e.target.setVolume(30); if(currentUser) e.target.playVideo(); } }
            }); 
        }

        document.getElementById('bgm-volume-slider').addEventListener('input', function(e) {
            const vol = e.target.value; document.getElementById('bgm-vol-value').innerText = vol + '%';
            if(player && player.setVolume) player.setVolume(vol);
        });

        document.getElementById('mic-sens-slider').addEventListener('input', function(e) {
            micSensitivity = parseFloat(e.target.value);
            document.getElementById('mic-sens-value').innerText = `x${micSensitivity.toFixed(1)}`;
            document.getElementById('mic-sens-slider-study').value = micSensitivity;
        });

        document.getElementById('mic-sens-slider-study').addEventListener('input', function(e) {
            micSensitivity = parseFloat(e.target.value);
            document.getElementById('mic-sens-slider').value = micSensitivity;
            document.getElementById('mic-sens-value').innerText = `x${micSensitivity.toFixed(1)}`;
        });

        setInterval(() => {
            const now = new Date();
             const timeEl = document.getElementById('top-time');
             const dateEl = document.getElementById('top-date');
             if(timeEl) timeEl.innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
             if(dateEl) dateEl.innerText = now.toLocaleDateString();
        }, 1000);
    </script>
</body>
</html>
